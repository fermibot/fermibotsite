- step_01_extract_screenplay:
    - "use PyPDF2 python script to read StanleyKubrick_1980_TheShining.pdf"
    - "write raw text to StanleyKubrick_1980_TheShining.txt"
    - "verify the screenplay text is complete and searchable (test with grep)"
    - "note the total number of pages and approximate runtime"
    - "result: 148 pages extracted to 8,756 lines of text"

- step_02_scene_extraction:
    - "study pages/stories/NeilBurger_2011_Limitless/limitless_scenes.json as template"
    - "USE AGENT (general-purpose or Explore) to systematically extract scenes"
    - "determine natural scene breaks based on DRAMATIC BEATS, not camera directions"
    - "target 30-40 narrative scenes (The Shining: 33 scenes from 231 camera setups)"
    - "count total scenes - verify against screenplay (NEVER pad with fake scenes!)"
    - "create StanleyKubrick_1980_TheShining_scenes.json with metadata section:"
    - "  - title, director, writer, year, runtime, genre, themes[], totalScenes, analysisDate"
    - "for each scene, extract from StanleyKubrick_1980_TheShining.txt:"
    - "  - id (sequential, starting at 1)"
    - "  - act (use 'TBD' for now - will assign in step_04)"
    - "  - title (concise, descriptive)"
    - "  - location (primary + description)"
    - "  - time (runtime timestamp + narrative description)"
    - "  - plotSummary (brief, detailed, subtext)"
    - "  - keyDialogue (array of {quote, speaker, significance, context})"
    - "  - characterDevelopment (Jack, Wendy, Danny with state + arc)"
    - "  - psychologicalState (Jack's mental state: stable/deteriorating/psychotic)"
    - "  - tensionLevel (1-10 scale)"
    - "  - significance (why this scene matters to the story)"
    - "  - foreshadowing (empty array [] for now - will populate in step_04)"
    - "  - tags (supernatural, family, isolation, madness, violence, symbolism, etc.)"

- step_03_data_validation:
    - "verify JSON is valid (python json.load() test)"
    - "verify ALL scene IDs are sequential 1 to N with no gaps"
    - "verify metadata.totalScenes matches len(scenes)"
    - "FIX any JSON syntax errors (common: closing } instead of ] in arrays)"
    - "verify character development tracks progression across all scenes"
    - "verify psychological state progression is logical (stable ‚Üí deteriorating ‚Üí psychotic)"
    - "count psychological states distribution (The Shining: stable=10, deteriorating=7, psychotic=16)"
    - "cross-reference key dialogue against screenplay text"
    - "ensure no fabricated content - everything must match screenplay"
    - "NOTE: foreshadowing will be empty at this stage - that's correct"

- step_04_act_structure_and_foreshadowing:
    - "determine natural three-act structure based on dramatic turning points:"
    - "  Act I: Setup and arrival at Overlook Hotel (scenes 1-9)"
    - "  Act II: Isolation and Jack's deterioration (scenes 10-26)"
    - "  Act III: Final confrontation and escape (scenes 27-33)"
    - "USE PYTHON to programmatically assign 'act' field: replace all 'TBD' with act1/act2/act3"
    - "verify act distribution feels balanced (The Shining: 9/17/7 - Act II longest)"
    - "choose act emojis that fit themes (The Shining: üèîÔ∏è arrival, üî• deterioration, ‚ùÑÔ∏è frozen)"
    - "choose act colors that match mood (The Shining: #4A90E2 blue, #D32F2F red, #212121 black)"
    - "ADD FORESHADOWING CONNECTIONS (now that acts are assigned):"
    - "  - use Python to add foreshadowing arrays to key scenes"
    - "  - create narrative web of connections (The Shining: 49 total connections)"
    - "  - verify ALL foreshadowing references point to valid scene IDs"
    - "  - example: scene 2 (Grady story) ‚Üí [8, 23, 25, 29] (confrontations, violence)"
    - "do NOT create redundant callbacks arrays (auto-generated from foreshadowing)"

- step_05_discussion_questions:
    - "create 15-20 thought-provoking discussion questions IN JAVASCRIPT"
    - "define DISCUSSION_QUESTIONS constant in StanleyKubrick_1980_TheShining_timeline.js"
    - "each question needs: {id, question, tags[], relatedScenes[]}"
    - "EXTRACT ALL UNIQUE TAGS used across all questions (The Shining: 32 tags)"
    - "ORGANIZE tags into 5-6 logical groups for display:"
    - "  - Core Themes (supernatural, psychology, interpretation, symbolism, identity)"
    - "  - Characters (jack, wendy, danny, family, children)"
    - "  - Horror Elements (madness, violence, abuse, evil, isolation, addiction)"
    - "  - Kubrick's Vision (kubrick, cinematography, visual, adaptation, history)"
    - "  - Key Symbols (hotel, maze, room-237, photograph, time, prophecy, environment)"
    - "  - Character Traits (psychic, survival, intelligence, escape)"
    - "question types to include:"
    - "  - Character psychology and motivation"
    - "  - Supernatural vs psychological interpretation"
    - "  - Symbolism and themes"
    - "  - Cinematography and visual storytelling"
    - "  - Family dynamics and isolation"
    - "  - Director's choices and adaptations"

- step_06_html_page:
    - "study pages/stories/NeilBurger_2011_Limitless/limitless.html"
    - "create StanleyKubrick_1980_TheShining.html based on Limitless template"
    - "use css/movie_timelines.css as base stylesheet"
    - "link to StanleyKubrick_1980_TheShining_custom.css?v=YYYY.MM.DD.HH.MM.SS"
    - "CRITICAL: Use placeholders for header/footer:"
    - "  - <div id='header_placeholder'></div>"
    - "  - <div id='footer_placeholder'></div> (NOT hardcoded footer)"
    - "CRITICAL: Add loadHeaderFooter script at END:"
    - "  <script>"
    - "    loadHeaderFooter('../../../automation/header.html', '../../../automation/footer.html');"
    - "  </script>"
    - "include sections:"
    - "  - Film overview with metadata"
    - "  - How to use the visualization (hover, click, Escape behavior)"
    - "  - Color legend for acts"
    - "  - Psychological state legend (or cognitive for other films)"
    - "  - Connection lines legend (foreshadowing/callbacks)"
    - "  - Key recurring themes section"
    - "  - Discussion questions section with:"
    - "    - <div id='questions-container'> (JS will populate this)"
    - "    - Sort toggle buttons (Film Order / Theme)"
    - "use timestamp versioning: ?v=YYYY.MM.DD.HH.MM.SS"

- step_07_visualization_js:
    - "study pages/stories/NeilBurger_2011_Limitless/limitless_timeline.js"
    - "create StanleyKubrick_1980_TheShining_timeline.js adapting from Limitless:"
    - "CRITICAL ADAPTATIONS:"
    - "  - CONFIG.DATA_FILE: 'StanleyKubrick_1980_TheShining_scenes.json'"
    - "  - cognitiveState ‚Üí psychologicalState everywhere"
    - "  - PSYCHOLOGICAL_COLORS: {stable, deteriorating, psychotic} not cognitive colors"
    - "  - ACT_COLORS: theme-appropriate (blue/red/black for The Shining)"
    - "  - ACT_ICONS: theme-appropriate (üèîÔ∏èüî•‚ùÑÔ∏è for The Shining)"
    - "  - Remove MDT tracking code (only relevant to Limitless)"
    - "INCLUDE from Limitless:"
    - "  - circular radial tree layout (D3.js)"
    - "  - connection logic: auto-generate callbacks from foreshadowing"
    - "  - for each foreshadowing A‚ÜíB, create:"
    - "    1. Foreshadowing link: A ‚Üí B (solid blue)"
    - "    2. Callback link: B ‚Üí A (dashed purple)"
    - "  - hover behavior: show tooltip when no node locked"
    - "  - click behavior: lock node, hide tooltip, show info card"
    - "  - Escape key: clear all selections and unlock"
    - "  - progressive disclosure: track viewed scenes in localStorage"
    - "  - act filtering with scene counts"
    - "  - psychological state filtering"
    - "  - search functionality with / keyboard shortcut"
    - "  - info card modal (side panel slide-in)"
    - "  - hideInfoCard, showInfoCard, toggleViewedFromCard functions"
    - "CRITICAL: IMPLEMENT renderDiscussionQuestions() function:"
    - "  - called from initialize() after loadProgress()"
    - "  - dynamically generate question cards from DISCUSSION_QUESTIONS array"
    - "  - for EACH question, show ALL tags in organized groups"
    - "  - mark tags as 'active' (in color) or 'inactive' (grayscale)"
    - "  - create tag groups structure with labels"
    - "  - add onclick handlers: highlightBookClubScenes(this, event)"
    - "  - add 'Show Answer' button with toggleAnswer(event, this)"
    - "use timestamp versioning: ?v=YYYY.MM.DD.HH.MM.SS"

- step_08_custom_css_critical_fixes:
    - "create StanleyKubrick_1980_TheShining_custom.css with CRITICAL FIXES AT TOP:"
    - "SECTION 1: INFO CARD MODAL FIX (MUST BE FIRST - critical override)"
    - "  .info-card-backdrop.active { opacity: 1; pointer-events: auto; }"
    - "  .info-card.active { opacity: 1; pointer-events: auto; }"
    - "  .info-card-modal {"
    - "    position: fixed; top: 0; right: 0;"
    - "    transform: translateX(100%);"
    - "    width: 400px; height: 100vh;"
    - "    transition: transform 0.3s ease, opacity 0.3s ease;"
    - "  }"
    - "  .info-card-modal.active {"
    - "    transform: translateX(0); opacity: 1; pointer-events: auto;"
    - "  }"
    - "  .info-card-backdrop { pointer-events: none !important; }"
    - "  #visualization-container, .visualization-main { overflow: visible; }"
    - "SECTION 2: COLOR VARIABLES"
    - "  --act1-color, --act2-color, --act3-color (theme appropriate)"
    - "  --stable-color, --deteriorating-color, --psychotic-color"
    - "  --overlook-gold, --snow-white, --blood-red (film-specific)"
    - "SECTION 3: PSYCHOLOGICAL STATE STYLING"
    - "  .psychological-state-badge.stable/deteriorating/psychotic"
    - "  node styling based on states"
    - "SECTION 4: BOOK CLUB GRID OVERRIDE"
    - "  .book-club-grid {"
    - "    display: grid;"
    - "    grid-template-columns: repeat(2, 1fr) !important;"
    - "    gap: 1rem;"
    - "  }"
    - "SECTION 5: TAG COLOR DEFINITIONS (END OF FILE)"
    - "  Define .tag-{name} for EVERY tag used (32 for The Shining)"
    - "  Pattern:"
    - "    .tag-supernatural {"
    - "      background: rgba(156, 39, 176, 0.1);"
    - "      color: #9C27B0;"
    - "      border-color: #9C27B0;"
    - "    }"
    - "  Use theme-appropriate color palette (horror colors for The Shining)"
    - "ADDITIONAL ENHANCEMENTS (optional):"
    - "  - Tension level indicators"
    - "  - Motif-specific styling (twins, maze, room-237)"
    - "  - Custom scrollbars"
    - "  - Symmetrical layouts (Kubrick aesthetic)"

- step_09_final_verification:
    - "CRITICAL VISUAL TESTS:"
    - "  ‚úì Header and footer load properly (not blank)"
    - "  ‚úì Info card slides in from RIGHT as side panel (not bottom of page)"
    - "  ‚úì Discussion questions appear in 2-column grid (not 5-6 columns)"
    - "  ‚úì ALL tags visible in each question with active/inactive states"
    - "  ‚úì Tag colors display correctly (not gray boxes)"
    - "INTERACTION TESTS:"
    - "  ‚úì Hover shows tooltip when no node is locked"
    - "  ‚úì Click locks node, hides tooltip, shows info card"
    - "  ‚úì Escape key clears selections and unlocks node"
    - "  ‚úì Click outside clears selections"
    - "  ‚úì Search works (press / to focus)"
    - "  ‚úì Act filtering works with correct scene counts"
    - "  ‚úì State filtering works (stable/deteriorating/psychotic)"
    - "  ‚úì Discussion questions highlight correct scenes when clicked"
    - "  ‚úì 'Show Answer' toggles work"
    - "DATA INTEGRITY TESTS:"
    - "  ‚úì All foreshadowing connections visualize correctly"
    - "  ‚úì No broken scene references (console errors)"
    - "  ‚úì All scene IDs are valid"
    - "  ‚úì Progress tracking persists in localStorage"
    - "RESPONSIVE DESIGN:"
    - "  ‚úì Mobile: questions become 1 column"
    - "  ‚úì Mobile: info card adjusts width"
    - "  ‚úì Check on different screen sizes"
    - "VERSION CONSISTENCY:"
    - "  ‚úì Same timestamp across HTML CSS and JS links"

- step_10_commit:
    - "commit with descriptive message following Limitless patterns"
    - "include Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
    - "verify git status is clean (no temp files)"

# ============================================
# KEY PRINCIPLES (from Limitless + The Shining)
# ============================================
# - NEVER pad scenes - only use scenes that actually exist in screenplay
# - Use only foreshadowing arrays (callbacks auto-generated by visualization)
# - All references must point to valid scene IDs
# - Character development must track throughout entire film
# - Verify everything against source screenplay - no fabricated content
# - Timestamp versioning for cache busting
# - Single source of truth for narrative connections
# - Use agents for complex extraction/analysis tasks
# - Programmatic data manipulation (Python) > manual editing
# - Critical CSS fixes go at TOP of custom stylesheet
# - renderDiscussionQuestions() must show ALL tags with active/inactive states
# - Test visual appearance AND interaction behavior

# ============================================
# POST-IMPLEMENTATION FIXES & LEARNINGS (2026-01-14)
# ============================================

- step_11_tag_system_fixes:
    - "CRITICAL ISSUE: TAG_GROUPS must use ACTUAL scene tags, not conceptual discussion tags"
    - "WRONG: TAG_GROUPS = {'Core Themes': ['psychology', 'interpretation', 'kubrick']}"
    - "RIGHT: TAG_GROUPS = {'Horror & Madness': ['supernatural', 'madness', 'violence']}"
    - "HOW TO FIX:"
    - "  1. Extract all unique tags from scene data: python -c 'import json; print(set(tag for scene in json.load(open(\"scenes.json\"))[\"scenes\"] for tag in scene.get(\"tags\", [])))'"
    - "  2. Update TAG_ICONS to map actual scene tags (supernatural, madness, hotel, maze, etc.)"
    - "  3. Organize TAG_GROUPS by actual tags used in scenes, not thematic discussion topics"
    - "  4. Verify every tag in TAG_GROUPS exists in at least one scene"
    - "RESULT: Clicking legend tags now correctly filters and highlights matching nodes"

- step_12_search_functionality_fix:
    - "CRITICAL ISSUE: Search highlighting not working - CSS uses filter: url(#glow) but SVG filter missing"
    - "SYMPTOM: Search counts matches but nodes don't glow or dim"
    - "FIX: Add SVG filter definition to visualization initialization:"
    - "  const defs = svg.append('defs');"
    - "  const filter = defs.append('filter')"
    - "    .attr('id', 'glow')"
    - "    .attr('x', '-50%').attr('y', '-50%')"
    - "    .attr('width', '200%').attr('height', '200%');"
    - "  filter.append('feGaussianBlur')"
    - "    .attr('in', 'SourceGraphic')"
    - "    .attr('stdDeviation', '3')"
    - "    .attr('result', 'blur');"
    - "  filter.append('feMerge')"
    - "    .selectAll('feMergeNode')"
    - "    .data(['blur', 'SourceGraphic'])"
    - "    .enter().append('feMergeNode').attr('in', d => d);"
    - "LOCATION: In initVisualization() after creating SVG, before creating g"
    - "RESULT: Search now properly glows matching nodes and dims others"

- step_13_legend_layout_fixes:
    - "CRITICAL ISSUE: Legend uses flexbox (display: flex) not CSS Grid"
    - "WRONG: .legend-section-label { grid-column: 1 / -1; }"
    - "RIGHT: .legend-section-label { flex-basis: 100%; width: 100%; }"
    - "Apply to ALL full-width legend elements:"
    - "  - .legend-separator"
    - "  - .legend-section-label"
    - "  - .legend-tag-group-row"
    - "  - .legend-connections-row"
    - "STRUCTURE for tag groups:"
    - "  - Each tag group = one .legend-tag-group-row (flex container)"
    - "  - Contains: .legend-tag-group-label + inline tag items"
    - "  - Set margin-bottom: 0.0rem for tight spacing (from Limitless pattern)"
    - "STRUCTURE for connection lines:"
    - "  - Single .legend-connections-row (flex container)"
    - "  - Contains: label + both connection types inline"
    - "SEPARATORS:"
    - "  - Add after: header, acts, psychological states, discussion topics"
    - "  - Style: height: 1px, opacity: 0.3, margin: 0.25rem 0"
    - "RESULT: Clean vertical layout with proper line breaks and spacing"

- step_14_tag_sizing_consistency:
    - "CRITICAL ISSUE: Legend tags taller in Limitless than Shining"
    - "ROOT CAUSE: Elements have both .legend-item AND .legend-question-item classes"
    - "  .legend-item has padding: 0.3rem 0.6rem (larger)"
    - "  .legend-question-item has padding: 0.2rem 0.5rem (smaller)"
    - "  Without !important, .legend-item wins due to specificity"
    - "FIX in movie_timelines.css (centralized):"
    - "  .legend-question-item {"
    - "    font-size: 0.75rem !important;  /* Override .legend-item's 0.85rem */"
    - "    padding: 0.2rem 0.5rem !important;  /* Override .legend-item's 0.3rem 0.6rem */"
    - "    line-height: 1.2 !important;  /* Compact vertical height */"
    - "  }"
    - "REMOVE padding from custom CSS files (limitless_custom.css, StanleyKubrick_1980_TheShining_custom.css)"
    - "RESULT: Consistent tag height across all visualizations"

- step_15_clickable_tags_in_questions:
    - "CRITICAL ISSUE: Tags in discussion questions not clickable"
    - "FIX 1: Add onclick to buildAllTagsWithHighlights() function:"
    - "  html += `<span class=\"tag-badge tag-${tag} ${activeClass}\""
    - "    title=\"Click to filter scenes with ${label}\""
    - "    onclick=\"window.toggleQuestionFilter('${tag}'); event.stopPropagation();\">"
    - "    ${icon} ${label}</span>`;"
    - "FIX 2: Expose function to window scope:"
    - "  window.toggleQuestionFilter = toggleQuestionFilter;"
    - "FIX 3: Update CSS - remove pointer-events: none from .question-tags .tag-badge"
    - "  .tag-badge { cursor: pointer; }  /* Make all tags clickable */"
    - "FIX 4: Update toggleQuestionFilter() to update badge visual states:"
    - "  - Add code to toggle .inactive class on badges based on legendState.activeQuestions"
    - "RESULT: Tags in questions are now clickable and filter visualization"

- step_16_centralized_css_architecture:
    - "MOVE all common legend styles to movie_timelines.css:"
    - "  - .legend-separator (flex-basis, height, opacity, margin)"
    - "  - .legend-section-label (flex-basis, font-size, color)"
    - "  - .legend-tag-group-row (flex-basis, display, gap, margin-bottom, line-height)"
    - "  - .legend-tag-group-label (font-size, font-weight, text-transform, letter-spacing)"
    - "  - .legend-connections-row (flex-basis, display, gap)"
    - "  - .legend-question-item (font-size, padding, line-height with !important)"
    - "REMOVE duplicate styles from custom CSS files"
    - "USE !important only when necessary to override multiple class specificity"
    - "BENEFIT: Single source of truth, consistent appearance, easier maintenance"
    - "PATTERN: movie_timelines.css = base/shared, custom.css = film-specific colors only"

# ============================================
# ADVANCED FEATURES & ENHANCEMENTS (2026-01-14)
# ============================================

- step_17_discussion_question_system_enhancements:
    - "PHASE 1: TAG SYNCHRONIZATION & CSS COMPLETION"
    - "  ISSUE: 17 tags in DISCUSSION_QUESTIONS didn't exist in scene data"
    - "  FIX: Used Python to extract all unique tags from StanleyKubrick_1980_TheShining_scenes.json"
    - "  python -c 'import json; tags = set(); [tags.update(s.get(\"tags\", [])) for s in json.load(open(\"StanleyKubrick_1980_TheShining_scenes.json\"))[\"scenes\"]]; print(sorted(tags))'"
    - "  UPDATED all 20 DISCUSSION_QUESTIONS to use only actual scene tags"
    - "  ADDED 10 missing tags to TAG_GROUPS: horror, murder, possession, ghosts, alcoholism, family-violence, etc."
    - "  ADDED complete CSS definitions for 25 missing tags in StanleyKubrick_1980_TheShining_custom.css:"
    - "    - Pattern: .tag-{name} { background, color, border-color }"
    - "    - Pattern: .legend-question-item.tag-{name} { same colors for legend }"
    - "    - Used horror-appropriate color palette (dark reds, purples, blacks)"
    - "  RESULT: All tags now have proper borders and colors in both legend and questions"
    - ""
    - "PHASE 2: SINGLE COLUMN LAYOUT FOR QUESTIONS"
    - "  ISSUE: Questions displayed in 2-column grid; StanleyKubrick_1980_TheShining_custom.css override not working"
    - "  FIX in StanleyKubrick_1980_TheShining_custom.css:"
    - "    .book-club-grid {"
    - "      display: grid;"
    - "      grid-template-columns: 1fr !important;  /* Force single column */"
    - "      gap: 1rem;"
    - "    }"
    - "  REMOVED media query overrides from movie_timelines.css"
    - "  RESULT: Questions always display in single column for better readability"
    - ""
    - "PHASE 3: TAG LAYOUT WITHIN QUESTION CARDS"
    - "  ISSUE: Tag groups (Characters, Key Locations) appearing on same line instead of separate rows"
    - "  CHANGED .legend-grid to CSS Grid layout in movie_timelines.css:"
    - "    .legend-grid {"
    - "      display: grid;"
    - "      grid-template-columns: 1fr;"
    - "      grid-auto-flow: row;"
    - "      gap: 0.5rem;"
    - "    }"
    - "  CHANGED .tag-group to block display:"
    - "    .tag-group {"
    - "      display: block;"
    - "      width: 100%;"
    - "      margin-bottom: 0.25rem;"
    - "    }"
    - "  CHANGED .question-tags from flex to block:"
    - "    .question-tags { display: block; margin-top: 0.5rem; }"
    - "  ADDED .legend-items-row wrapper for horizontal groups (Acts, Psychological States)"
    - "  RESULT: Each tag category appears on its own line within question cards"

- step_18_screenplay_based_answers:
    - "ISSUE: Discussion question answers were placeholders ('This explores...')"
    - "REQUIREMENT: Detailed answers using ONLY screenplay content, no external interpretation"
    - "IMPLEMENTATION: Updated all 20 DISCUSSION_QUESTIONS in StanleyKubrick_1980_TheShining_timeline.js:"
    - "  - Each answer references specific scene numbers and screenplay moments"
    - "  - Analyzes character psychology, symbolism, and narrative progression"
    - "  - Uses concrete examples from dialogue, visuals, and character actions"
    - "  EXAMPLE - Question 1 (supernatural vs psychological):"
    - "    'Scene 2 shows Ullman mentioning previous caretaker murder-suicide, planting seeds'"
    - "    'Scene 6: Jack dreams of killing family, suggesting pre-existing violent ideation'"
    - "    'Scene 12: Jack meets Grady who claims \"You've always been the caretaker\"'"
    - "    'Scene 23: \"All work and no play\" manuscript reveals complete mental break'"
    - "    'Final photograph (Scene 33) suggests cyclical supernatural entrapment'"
    - "  - Answer length: 4-8 sentences with scene-specific analysis"
    - "  - Focus on \"why\" and \"how\" rather than just summarizing events"
    - "UPDATED renderDiscussionQuestions() to display answers:"
    - "  - Added answer paragraph with class 'question-answer'"
    - "  - Display logic: q.answer || 'Analysis coming soon.'"
    - "  - Toggle with 'Show Answer' / 'Hide Answer' button"
    - "RESULT: Rich, screenplay-grounded analysis for book clubs and film classes"

- step_19_timeline_theme_sorting:
    - "ISSUE: Default sort was 'Film Order'; wanted 'Timeline' with Theme as secondary option"
    - "FIX 1: Changed button label from 'Film Order' to 'Timeline' in StanleyKubrick_1980_TheShining.html"
    - "FIX 2: Updated sortQuestions() function in StanleyKubrick_1980_TheShining_timeline.js:"
    - "  - Timeline mode: Dynamically renumber questions 1-20 sequentially"
    - "    questions.forEach((question, index) => {"
    - "      numberSpan.textContent = index + 1;  // Sequential 1-20"
    - "    });"
    - "  - Theme mode: Preserve original question IDs from dataset.originalNumber"
    - "    numberSpan.textContent = question.dataset.originalNumber;"
    - "  - Store original ID on mount: question.dataset.originalNumber = q.id"
    - "RESULT: Questions naturally flow 1-20 in timeline mode, group by theme in theme mode"

- step_20_tag_filtering_system:
    - "FEATURE: Click tags in Discussion Topics legend to filter questions and highlight nodes"
    - ""
    - "IMPLEMENTATION 1: Clear Filter Button"
    - "  ADDED button in StanleyKubrick_1980_TheShining.html:"
    - "    <button class='btn btn-sm btn-outline-danger' id='clear-question-filter' style='display: none;'>"
    - "      Clear Filter"
    - "    </button>"
    - "  AUTO-SHOW when filters active, AUTO-HIDE when no filters"
    - "  FUNCTION clearQuestionFilter() clears legendState.activeQuestions Set"
    - ""
    - "IMPLEMENTATION 2: Question Card Filtering"
    - "  FUNCTION filterQuestionCards() in StanleyKubrick_1980_TheShining_timeline.js:"
    - "    - Check if question has any tags matching legendState.activeQuestions"
    - "    - Hide questions that don't match: questionCard.style.display = 'none'"
    - "    - Show matching questions: questionCard.style.display = ''"
    - "  CALLED from toggleQuestionFilter() whenever tags are clicked"
    - ""
    - "IMPLEMENTATION 3: Tag Highlighting State Management"
    - "  COMPLEX LOGIC to handle three states:"
    - "    A. No filters active: Show each question's own tags as active, others as inactive"
    - "    B. Filters active: Show ALL question's tags, but add special styling to filtered ones"
    - "    C. After clearing: Restore state A (original state)"
    - "  CODE PATTERN:"
    - "    const hasActiveFilters = legendState.activeQuestions.size > 0;"
    - "    if (hasActiveFilters) {"
    - "      if (questionData.tags.includes(tag)) {  // Tag belongs to this question"
    - "        badge.classList.remove('inactive');"
    - "        if (legendState.activeQuestions.has(tag)) {"
    - "          badge.classList.add('tag-filter-match');  // Bright outline"
    - "        } else {"
    - "          badge.classList.remove('tag-filter-match');"
    - "        }"
    - "      } else {  // Tag doesn't belong to this question"
    - "        badge.classList.add('inactive');"
    - "      }"
    - "    } else {  // No filters - restore original state"
    - "      badge.classList.remove('tag-filter-match');"
    - "      if (questionData.tags.includes(tag)) {"
    - "        badge.classList.remove('inactive');"
    - "      } else {"
    - "        badge.classList.add('inactive');"
    - "      }"
    - "    }"
    - ""
    - "IMPLEMENTATION 4: Non-Clickable Tags in Questions"
    - "  ISSUE: Tags in question cards shouldn't be clickable (filtering happens in legend only)"
    - "  ADDED .tag-non-clickable class to tags in buildAllTagsWithHighlights():"
    - "    html += `<span class='tag-badge tag-${tag} ${activeClass} tag-non-clickable'...`"
    - "  CSS in movie_timelines.css:"
    - "    .tag-badge.tag-non-clickable {"
    - "      cursor: default;"
    - "      pointer-events: none;"
    - "    }"
    - "  RESULT: Users can only filter via legend tags, not question card tags"
    - ""
    - "IMPLEMENTATION 5: Bright Outline for Filtered Tags"
    - "  REQUIREMENT: When filtering, show ALL question's relevant tags but highlight filtered ones"
    - "  ADDED .tag-filter-match class with golden outline in movie_timelines.css:"
    - "    .tag-badge.tag-filter-match {"
    - "      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.6), 0 0 8px rgba(255, 215, 0, 0.4);"
    - "      border-width: 2px;"
    - "      font-weight: 700;"
    - "    }"
    - "  DARK MODE enhancement:"
    - "    [data-bs-theme='dark'] .tag-badge.tag-filter-match {"
    - "      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.8), 0 0 12px rgba(255, 215, 0, 0.5);"
    - "    }"
    - "  VISUAL EFFECT: Bright golden halo around filtered tags, all other tags remain visible"
    - ""
    - "DEBUGGING JOURNEY:"
    - "  - Initial attempt: Used regex /tag-(\S+)/ to extract tag name ‚Üí matched 'badge' instead"
    - "  - Fixed: Split className and find class starting with 'tag-' that isn't 'tag-badge'"
    - "  - Issue: Empty filter Set was being treated same as filter with items"
    - "  - Fixed: Added hasActiveFilters boolean check before applying logic"
    - "  - Issue: Clearing filters made all tags inactive"
    - "  - Fixed: Restore original state - check if tag belongs to question"
    - "  - Issue: Wrong tags highlighted in wrong questions"
    - "  - Fixed: Check BOTH legendState.activeQuestions.has(tag) AND questionData.tags.includes(tag)"
    - ""
    - "FINAL BEHAVIOR:"
    - "  1. Click 'supernatural' in Discussion Topics legend"
    - "  2. Only questions with 'supernatural' tag are displayed"
    - "  3. Those questions show ALL their relevant tags (supernatural, possession, madness, etc.)"
    - "  4. 'supernatural' tag has bright golden outline"
    - "  5. Other tags (possession, madness) are visible but without outline"
    - "  6. Nodes with 'supernatural' tag are highlighted in visualization"
    - "  7. Click 'Clear Filter' ‚Üí all questions reappear, outlines disappear, original state restored"

- step_21_css_variable_consistency:
    - "ISSUE: Character development styling not consistent with Limitless"
    - "FIX: Added --viz-primary CSS variable to both StanleyKubrick_1980_TheShining_custom.css files:"
    - "  :root {"
    - "    --viz-primary: #4A90E2;  /* Match primary theme color */"
    - "  }"
    - "UPDATED .character-block and .character-name to use var(--viz-primary)"
    - "RESULT: Consistent theming across character development sections"

# ============================================
# COMMON PITFALLS TO AVOID
# ============================================
# 1. Don't create TAG_GROUPS with tags that don't exist in scene data
# 2. Don't forget SVG filter definitions when using CSS filter: url(#id)
# 3. Don't mix grid-column with flexbox layouts (use flex-basis instead)
# 4. Don't skip !important when element has multiple conflicting classes
# 5. Don't forget to expose functions to window scope for HTML onclick handlers
# 6. Always verify tag filtering actually highlights matching nodes (test with python scene tag extraction)
# 7. Always check both visualizations for consistency when updating shared CSS
# 8. Line-height significantly affects tag height - set explicitly for consistency
# 9. Tag state management requires checking BOTH filter state AND question membership
# 10. Empty Set vs populated Set requires different handling in conditional logic
# 11. CSS Grid better than flexbox for strict row-based layouts (tag categories)
# 12. When filtering with visual indicators, show ALL relevant items but highlight matches
# 13. Tag extraction from className needs careful parsing to avoid matching meta-classes like 'tag-badge'

# ============================================
# KEY LEARNINGS FROM ADVANCED FEATURES (2026-01-14)
# ============================================

- lesson_01_tag_state_complexity:
    - "Managing tag states across three contexts is complex:"
    - "  1. Legend tags (clickable filters)"
    - "  2. Question tags (display-only, reflect filter state)"
    - "  3. Node tags (highlight when filtered)"
    - "SOLUTION: Single source of truth (legendState.activeQuestions Set)"
    - "PATTERN: Check filter state first, then apply context-specific logic"
    - "CRITICAL: Always distinguish between 'no filter' and 'filter exists' states"

- lesson_02_progressive_enhancement_ux:
    - "Better UX: Show all information but highlight what matters"
    - "BAD: Hide non-matching tags when filtering (loses context)"
    - "GOOD: Show all tags but add bright outline to matching ones"
    - "BENEFIT: Users see full context while focusing on filtered content"
    - "IMPLEMENTATION: Use additive CSS classes (.tag-filter-match) not removal"

- lesson_03_layout_system_choices:
    - "CSS Grid vs Flexbox decision tree:"
    - "  - Use Grid: When elements MUST be in separate rows/columns (tag categories)"
    - "  - Use Flexbox: When elements can wrap and flow (individual tags)"
    - "  - Use both: Grid for outer structure, flexbox for inner content"
    - "SHINING EXAMPLE:"
    - "  - .legend-grid: CSS Grid (single column, strict rows)"
    - "  - .tag-group: Block display (each category on own line)"
    - "  - Individual tags within group: Inline flow (natural wrapping)"

- lesson_04_screenplay_based_analysis:
    - "Discussion answers must be grounded in observable screenplay content"
    - "TECHNIQUE: Reference specific scene numbers"
    - "TECHNIQUE: Quote or paraphrase key dialogue"
    - "TECHNIQUE: Describe visual symbolism shown on screen"
    - "TECHNIQUE: Analyze character actions and progression"
    - "AVOID: External theories not supported by film"
    - "AVOID: Generic statements without scene references"
    - "RESULT: Answers serve as mini film analysis lessons"

- lesson_05_filter_restoration_pattern:
    - "When clearing filters, must restore original state exactly"
    - "PATTERN:"
    - "  1. Store original state implicitly (question's own tags)"
    - "  2. On filter clear: legendState.activeQuestions.clear()"
    - "  3. For each tag in each question:"
    - "     if (questionData.tags.includes(tag)) ‚Üí active"
    - "     else ‚Üí inactive"
    - "  4. Remove all filter-specific classes (.tag-filter-match)"
    - "DEBUGGING TIP: Log both Set size and individual tag checks"

- lesson_06_class_name_extraction:
    - "Extracting tag names from className string is error-prone"
    - "WRONG: /tag-(\S+)/.exec(className)[1] ‚Üí matches 'badge' from 'tag-badge'"
    - "RIGHT: className.split(' ').find(c => c.startsWith('tag-') && c !== 'tag-badge')"
    - "BETTER: Use data attributes (data-tag='supernatural') for cleaner access"
    - "LESSON: Avoid regex for multi-class elements; use explicit parsing"

# ============================================
# REUSABLE CODE PATTERNS
# ============================================

- pattern_01_tag_filtering_with_visual_retention:
    code: |
      // Show all question's tags, but highlight filtered ones
      const hasActiveFilters = legendState.activeQuestions.size > 0;

      questionCard.querySelectorAll('.tag-badge').forEach(badge => {
        const tag = extractTagName(badge); // Get 'supernatural' from 'tag-supernatural'

        if (hasActiveFilters) {
          if (questionData.tags.includes(tag)) {
            badge.classList.remove('inactive');
            // Add special styling if this tag is being filtered
            if (legendState.activeQuestions.has(tag)) {
              badge.classList.add('tag-filter-match');
            } else {
              badge.classList.remove('tag-filter-match');
            }
          } else {
            badge.classList.add('inactive');
          }
        } else {
          // No filter: restore original state
          badge.classList.remove('tag-filter-match');
          badge.classList.toggle('inactive', !questionData.tags.includes(tag));
        }
      });

- pattern_02_clear_filter_restoration:
    code: |
      function clearQuestionFilter() {
        // Clear filter state
        legendState.activeQuestions.clear();

        // Update legend visual state
        d3.selectAll('.legend-question-item').classed('active', false);

        // Restore all question tags to original state
        document.querySelectorAll('.book-club-question').forEach(card => {
          const questionData = findQuestionData(card);

          card.querySelectorAll('.tag-badge').forEach(badge => {
            const tag = extractTagName(badge);
            badge.classList.remove('tag-filter-match');
            badge.classList.toggle('inactive', !questionData.tags.includes(tag));
          });

          // Show all question cards
          card.style.display = '';
        });

        // Clear visualization filters
        applyLegendFilters();
      }

- pattern_03_dynamic_question_numbering:
    code: |
      function sortQuestions(sortType) {
        const container = document.getElementById('questions-container');
        const questions = Array.from(container.querySelectorAll('.book-club-question'));

        // Sort by criteria
        questions.sort((a, b) => {
          if (sortType === 'film-order') {
            return parseInt(a.dataset.originalNumber) - parseInt(b.dataset.originalNumber);
          } else {
            // Sort by theme/tags
            return a.dataset.theme.localeCompare(b.dataset.theme);
          }
        });

        // Re-append and renumber
        questions.forEach((question, index) => {
          container.appendChild(question);
          const numberSpan = question.querySelector('.question-number');
          if (sortType === 'film-order') {
            numberSpan.textContent = index + 1; // Sequential 1-20
          } else {
            numberSpan.textContent = question.dataset.originalNumber; // Original ID
          }
        });
      }

# ============================================
# TESTING CHECKLIST FOR FILTER FEATURES
# ============================================

- filter_testing_checklist:
    - "INITIAL STATE (No filters):"
    - "  ‚úì All questions visible"
    - "  ‚úì Each question shows only its own tags as active (colored)"
    - "  ‚úì Tags from other questions shown as inactive (grayscale)"
    - "  ‚úì Clear Filter button hidden"
    - ""
    - "FILTER ACTIVE STATE (Click 'supernatural' in legend):"
    - "  ‚úì Only questions with 'supernatural' tag visible"
    - "  ‚úì Other questions hidden (display: none)"
    - "  ‚úì Visible questions show ALL their own tags"
    - "  ‚úì 'supernatural' tag has bright golden outline"
    - "  ‚úì Other tags (if belonging to question) remain colored but no outline"
    - "  ‚úì Clear Filter button visible"
    - "  ‚úì Nodes with 'supernatural' tag highlighted in visualization"
    - ""
    - "AFTER CLEAR FILTER:"
    - "  ‚úì All questions visible again"
    - "  ‚úì All golden outlines removed"
    - "  ‚úì Tags return to original state (active if belongs to question, inactive otherwise)"
    - "  ‚úì Clear Filter button hidden"
    - "  ‚úì Visualization returns to normal (all nodes visible)"
    - ""
    - "EDGE CASES:"
    - "  ‚úì Click same tag twice ‚Üí toggles filter off"
    - "  ‚úì Click multiple tags ‚Üí union (OR) filtering"
    - "  ‚úì Tags in questions not clickable (legend only)"
    - "  ‚úì Search + filter work together"
    - "  ‚úì Sort + filter preserve filter state"

# My original outline for The Shining based on Limitless:
#- step_01:
#    - "read StanleyKubrick_1980_TheShining.pdf"
#    - "write raw to StanleyKubrick_1980_TheShining.txt"
#- step_02:
#    - "study pages/stories/NeilBurger_2011_Limitless/limitless_scenes.json"
#    - "determine the number of scenes that fit this movie"
#    - "fix the number of scenes and keep always going back to the StanleyKubrick_1980_TheShining.txt for reference"
#    - "extract scenes from StanleyKubrick_1980_TheShining.txt using
#    -limitless_scenes.json as a template"
#- step_03:
#    - "study pages/stores/NeilBurger_2011_Limitless/limitless.html"
#    - "use css/movie_timelines.css as the base css for StanleyKubrick_1980_TheShining.html"
#    - "add any more css needed to StanleyKubrick_1980_TheShining.css"
#- step_04:
#    - "study pages/stories/NeilBurger_2011_Limitless/limitless_timeline.js"
#    - "create StanleyKubrick_1980_TheShining.js to visualize the scenes extracted in -step_02"
#    - "Include any additional javascript needed for -StanleyKubrick_1980_TheShining.html"
#- step_05:
#      "In addition to the templates, use creative spins to make StanleyKubrick_1980_TheShining.html unique and interesting"