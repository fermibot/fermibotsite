<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wellness | Coherent Breathing</title>

    <link rel="stylesheet" href="../../../d3_templates/hierarchical_dendrogram.css">
    <link rel="stylesheet" href="../../../index.css">
    <link rel="stylesheet" href="../../../bootstrap/css/bootstrap.min.css">

    <script src="../../../d3/d3.v4.min.js"></script>
    <script src="../../../automation/loadObjects.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../../js/highlight/styles/default.css">
    <link rel="stylesheet" href="../../../bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../external_libraries/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../../index.css">

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"></script>

    <script src="../../../js/highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <style>
        .audio-controls {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            border: 1px solid #dee2e6;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .card {
            border: 1px solid rgba(139, 69, 19, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: 100%;
        }

        .card-title {
            color: #8B4513;
            font-weight: 600;
        }

        .btn-outline-primary {
            border-color: #8B4513;
            color: #8B4513;
        }

        .btn-outline-primary:hover {
            background-color: #8B4513;
            border-color: #8B4513;
        }

        .btn-outline-primary.active {
            background-color: #8B4513;
            color: white;
        }

        .audio-status {
            font-size: 0.9rem;
            margin-top: 10px;
            color: #666;
        }

        .audio-loading {
            color: #8B4513;
            font-style: italic;
        }

        /* Session timer styles */
        .session-timer-container {
            background: linear-gradient(135deg, #fdf6e3, #f5e6d3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #e0c9a6;
            text-align: center;
        }

        .session-timer {
            font-size: 1.8rem;
            font-weight: 700;
            color: #8B4513;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .timer-label {
            font-size: 0.9rem;
            color: #996633;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        /* Icons for new patterns */
        .pattern-icon {
            font-size: 1.2rem;
            margin-right: 5px;
        }

        .pattern-description {
            min-height: 48px;
        }

        .currently-playing {
            background-color: rgba(139, 69, 19, 0.05);
            border: 2px solid #8B4513;
            box-shadow: 0 5px 20px rgba(139, 69, 19, 0.15);
        }

        .currently-playing .card-title {
            color: #5D2906;
            font-weight: 700;
        }
    </style>
</head>
<body>

<div class="container-lg card p-5">
    <div id="header_placeholder"></div>

    <h1 class="d-grid gap-3 justify-content-center p-2 mb-4" style="color: #8B4513;">Wellness | Coherent Breathing</h1>

    <p class="text-center mb-4" style="font-size: 1.1rem; color: #555;">Experience the harmony of breath and nature.
        This has been an elixir for me for many years. The benefits are invaluable and long-lasting.</p>

    <!-- Session Timer Display -->
    <div class="session-timer-container">
        <div class="timer-label">Session Timer</div>
        <div class="session-timer" id="sessionTimer">00:00:00</div>
        <div class="mt-2" style="font-size: 0.8rem; color: #996633;">
            ‚è±Ô∏è Timer resets when switching patterns. Only one pattern plays at a time.
        </div>
    </div>

    <!-- Audio Controls -->
    <div class="audio-controls">
        <h4 class="mb-4" style="color: #8B4513; text-align: center;">Choose Your Breathing Pattern</h4>

        <div class="row">
            <!-- First Row: 5-5 and 6-6 Patterns -->
            <div class="col-md-6 mb-4">
                <div class="card h-100" id="card-55">
                    <div class="card-body text-center">
                        <h5 class="card-title">üåº 5-5 Breathing Pattern</h5>
                        <p class="card-text pattern-description">5 seconds inhale, 5 seconds exhale - For energy and focus</p>

                        <!-- Seamless Web Audio API Player -->
                        <div class="seamless-audio-player" data-audio-id="55">
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-play" disabled>
                                    ‚ñ∂Ô∏è Play
                                </button>
                                <button class="btn btn-outline-secondary btn-pause" disabled>
                                    ‚è∏Ô∏è Pause
                                </button>
                                <button class="btn btn-outline-secondary btn-stop" disabled>
                                    ‚èπÔ∏è Stop
                                </button>
                            </div>
                            <div class="audio-status">
                                <span class="loading-status audio-loading">Loading audio...</span>
                                <span class="time-status" style="display: none;"></span>
                            </div>
                            <!-- Hidden fallback audio element for browsers without Web Audio API -->
                            <audio class="fallback-audio" controls loop style="display: none;">
                                <source src="Coherent_Piano_5_5_fermibot.mp3" type="audio/mp3">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card h-100" id="card-66">
                    <div class="card-body text-center">
                        <h5 class="card-title">üå∏ 6-6 Breathing Pattern</h5>
                        <p class="card-text pattern-description">6 seconds inhale, 6 seconds exhale - Perfect for relaxation</p>

                        <!-- Seamless Web Audio API Player -->
                        <div class="seamless-audio-player" data-audio-id="66">
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-play" disabled>
                                    ‚ñ∂Ô∏è Play
                                </button>
                                <button class="btn btn-outline-secondary btn-pause" disabled>
                                    ‚è∏Ô∏è Pause
                                </button>
                                <button class="btn btn-outline-secondary btn-stop" disabled>
                                    ‚èπÔ∏è Stop
                                </button>
                            </div>
                            <div class="audio-status">
                                <span class="loading-status audio-loading">Loading audio...</span>
                                <span class="time-status" style="display: none;"></span>
                            </div>
                            <!-- Hidden fallback audio element for browsers without Web Audio API -->
                            <audio class="fallback-audio" controls loop style="display: none;">
                                <source src="Coherent_Piano_6_6_fermibot.mp3" type="audio/mp3">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Second Row: 7-7 and 8-8 Patterns -->
            <div class="col-md-6 mb-4">
                <div class="card h-100" id="card-77">
                    <div class="card-body text-center">
                        <h5 class="card-title">üåø 7-7 Breathing Pattern</h5>
                        <p class="card-text pattern-description">7 seconds inhale, 7 seconds exhale - For deep relaxation</p>

                        <!-- Seamless Web Audio API Player -->
                        <div class="seamless-audio-player" data-audio-id="77">
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-play" disabled>
                                    ‚ñ∂Ô∏è Play
                                </button>
                                <button class="btn btn-outline-secondary btn-pause" disabled>
                                    ‚è∏Ô∏è Pause
                                </button>
                                <button class="btn btn-outline-secondary btn-stop" disabled>
                                    ‚èπÔ∏è Stop
                                </button>
                            </div>
                            <div class="audio-status">
                                <span class="loading-status audio-loading">Loading audio...</span>
                                <span class="time-status" style="display: none;"></span>
                            </div>
                            <!-- Hidden fallback audio element for browsers without Web Audio API -->
                            <audio class="fallback-audio" controls loop style="display: none;">
                                <source src="Coherent_Piano_7_7_fermibot.mp3" type="audio/mp3">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card h-100" id="card-88">
                    <div class="card-body text-center">
                        <h5 class="card-title">üåä 8-8 Breathing Pattern</h5>
                        <p class="card-text pattern-description">8 seconds inhale, 8 seconds exhale - For meditation and calm</p>

                        <!-- Seamless Web Audio API Player -->
                        <div class="seamless-audio-player" data-audio-id="88">
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-play" disabled>
                                    ‚ñ∂Ô∏è Play
                                </button>
                                <button class="btn btn-outline-secondary btn-pause" disabled>
                                    ‚è∏Ô∏è Pause
                                </button>
                                <button class="btn btn-outline-secondary btn-stop" disabled>
                                    ‚èπÔ∏è Stop
                                </button>
                            </div>
                            <div class="audio-status">
                                <span class="loading-status audio-loading">Loading audio...</span>
                                <span class="time-status" style="display: none;"></span>
                            </div>
                            <!-- Hidden fallback audio element for browsers without Web Audio API -->
                            <audio class="fallback-audio" controls loop style="display: none;">
                                <source src="Coherent_Piano_8_8_fermibot.mp3" type="audio/mp3">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <p class="text-muted" style="font-size: 0.9rem;">
                <strong>Note:</strong> Using Web Audio API for seamless looping without gaps between cycles.
                Only one pattern can play at a time. Timer resets when switching patterns.
            </p>
        </div>
    </div>

    <div id="footer_placeholder"></div>
</div>

<script>
    loadHeaderFooter("../../../automation/header.html", "../../../automation/footer.html", "../../../automation/theme_toggle.html")
</script>

<script>
    // Session Timer Manager
    class SessionTimer {
        constructor() {
            this.timerElement = document.getElementById('sessionTimer');
            this.startTime = null;
            this.elapsedTime = 0;
            this.timerInterval = null;
            this.isRunning = false;
        }

        start() {
            if (this.isRunning) return;

            this.startTime = Date.now() - this.elapsedTime;
            this.isRunning = true;

            this.timerInterval = setInterval(() => {
                this.updateDisplay();
            }, 1000);

            this.updateDisplay();
        }

        pause() {
            if (!this.isRunning) return;

            this.elapsedTime = Date.now() - this.startTime;
            this.isRunning = false;

            if (this.timerInterval) {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
            }
        }

        stop() {
            this.isRunning = false;
            this.elapsedTime = 0;
            this.startTime = null;

            if (this.timerInterval) {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
            }

            this.updateDisplay();
        }

        resetAndStart() {
            this.stop();
            this.start();
        }

        updateDisplay() {
            let displayTime = this.elapsedTime;

            if (this.isRunning && this.startTime) {
                displayTime = Date.now() - this.startTime;
            }

            const hours = Math.floor(displayTime / 3600000);
            const minutes = Math.floor((displayTime % 3600000) / 60000);
            const seconds = Math.floor((displayTime % 60000) / 1000);

            this.timerElement.textContent =
                `${hours.toString().padStart(2, '0')}:` +
                `${minutes.toString().padStart(2, '0')}:` +
                `${seconds.toString().padStart(2, '0')}`;
        }
    }

    // Audio Player Manager - controls all players
    class AudioPlayerManager {
        constructor(sessionTimer) {
            this.sessionTimer = sessionTimer;
            this.players = {};
            this.currentPlayer = null;
        }

        registerPlayer(playerId, player) {
            this.players[playerId] = player;
        }

        switchToPlayer(playerId, player) {
            // If there's a currently playing player, stop it first
            if (this.currentPlayer && this.currentPlayer !== playerId) {
                this.players[this.currentPlayer].stop();
                // Remove active styling from previous player's card
                const prevCard = document.getElementById(`card-${this.currentPlayer}`);
                if (prevCard) {
                    prevCard.classList.remove('currently-playing');
                }
            }

            // Reset timer and start new session
            this.sessionTimer.resetAndStart();

            // Set new current player
            this.currentPlayer = playerId;

            // Add active styling to new player's card
            const currentCard = document.getElementById(`card-${playerId}`);
            if (currentCard) {
                currentCard.classList.add('currently-playing');
            }

            return player;
        }

        playerStopped(playerId) {
            // If the stopped player was the current player, clear current player
            if (this.currentPlayer === playerId) {
                this.currentPlayer = null;
                // Remove active styling from card
                const card = document.getElementById(`card-${playerId}`);
                if (card) {
                    card.classList.remove('currently-playing');
                }
            }
        }
    }

    // Seamless Audio Player using Web Audio API
    class SeamlessAudioPlayer {
        constructor(container, audioUrl, playerId, playerManager) {
            this.container = container;
            this.audioUrl = audioUrl;
            this.playerId = playerId;
            this.playerManager = playerManager;
            this.audioContext = null;
            this.audioBuffer = null;
            this.sourceNode = null;
            this.isPlaying = false;
            this.startTime = 0;
            this.pauseTime = 0;
            this.isWebAudioSupported = !!window.AudioContext || !!window.webkitAudioContext;

            // UI Elements
            this.playBtn = container.querySelector('.btn-play');
            this.pauseBtn = container.querySelector('.btn-pause');
            this.stopBtn = container.querySelector('.btn-stop');
            this.loadingStatus = container.querySelector('.loading-status');
            this.timeStatus = container.querySelector('.time-status');
            this.fallbackAudio = container.querySelector('.fallback-audio');

            this.init();
        }

        async init() {
            if (this.isWebAudioSupported) {
                try {
                    // Initialize Audio Context (will be suspended until user interaction)
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();

                    // Load and decode audio
                    await this.loadAudio();

                    // Enable buttons
                    this.playBtn.disabled = false;
                    this.pauseBtn.disabled = false;
                    this.stopBtn.disabled = false;

                    // Update status
                    this.loadingStatus.textContent = 'Ready';
                    this.loadingStatus.classList.remove('audio-loading');
                    this.timeStatus.style.display = 'inline';

                    // Set up event listeners
                    this.setupEventListeners();

                } catch (error) {
                    console.error('Error initializing Web Audio:', error);
                    this.fallbackToHTML5Audio();
                }
            } else {
                this.fallbackToHTML5Audio();
            }
        }

        async loadAudio() {
            try {
                const response = await fetch(this.audioUrl);
                const arrayBuffer = await response.arrayBuffer();
                this.audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
            } catch (error) {
                console.error('Error loading audio:', error);
                throw error;
            }
        }

        fallbackToHTML5Audio() {
            console.log('Web Audio API not supported, falling back to HTML5 Audio');
            this.isWebAudioSupported = false;

            // Show the fallback audio controls
            this.fallbackAudio.style.display = 'block';

            // Hide Web Audio controls
            this.playBtn.style.display = 'none';
            this.pauseBtn.style.display = 'none';
            this.stopBtn.style.display = 'none';
            this.loadingStatus.textContent = 'Using standard audio player';
            this.loadingStatus.classList.remove('audio-loading');
        }

        setupEventListeners() {
            this.playBtn.addEventListener('click', () => this.play());
            this.pauseBtn.addEventListener('click', () => this.pause());
            this.stopBtn.addEventListener('click', () => this.stop());

            // Resume audio context on first user interaction (required by browsers)
            const resumeAudioContext = () => {
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                document.removeEventListener('click', resumeAudioContext);
                document.removeEventListener('touchstart', resumeAudioContext);
            };

            document.addEventListener('click', resumeAudioContext);
            document.addEventListener('touchstart', resumeAudioContext);
        }

        play() {
            if (!this.isWebAudioSupported) return;

            if (this.isPlaying) return;

            if (this.audioContext.state === 'suspended') {
                this.audioContext.resume();
            }

            // Notify player manager to switch to this player
            this.playerManager.switchToPlayer(this.playerId, this);

            this.sourceNode = this.audioContext.createBufferSource();
            this.sourceNode.buffer = this.audioBuffer;
            this.sourceNode.loop = true; // Seamless looping

            // Connect to destination
            this.sourceNode.connect(this.audioContext.destination);

            // Calculate start time (resume from pause time or start from beginning)
            const startOffset = this.pauseTime % this.audioBuffer.duration;

            // Start playing
            this.sourceNode.start(0, startOffset);
            this.startTime = this.audioContext.currentTime - startOffset;
            this.isPlaying = true;

            // Update UI
            this.playBtn.disabled = true;
            this.pauseBtn.disabled = false;
            this.playBtn.classList.add('active');
            this.updateTimeDisplay();

            // Set up periodic time updates
            this.timeUpdateInterval = setInterval(() => this.updateTimeDisplay(), 100);

            // Handle when audio naturally ends (shouldn't happen with loop=true, but just in case)
            this.sourceNode.onended = () => {
                if (this.isPlaying) {
                    // Immediately restart for seamless playback
                    this.stop();
                    this.play();
                }
            };
        }

        pause() {
            if (!this.isWebAudioSupported || !this.isPlaying) return;

            // Pause session timer
            this.playerManager.sessionTimer.pause();

            // Calculate current play position
            this.pauseTime = (this.audioContext.currentTime - this.startTime) % this.audioBuffer.duration;

            // Stop the current source
            this.sourceNode.stop();
            this.sourceNode.disconnect();
            this.isPlaying = false;

            // Update UI
            this.playBtn.disabled = false;
            this.pauseBtn.disabled = true;
            this.playBtn.classList.remove('active');

            // Clear time update interval
            clearInterval(this.timeUpdateInterval);
        }

        stop() {
            if (!this.isWebAudioSupported) return;

            // Notify player manager that this player stopped
            this.playerManager.playerStopped(this.playerId);

            // Stop session timer
            this.playerManager.sessionTimer.stop();

            if (this.isPlaying) {
                this.sourceNode.stop();
                this.sourceNode.disconnect();
                this.isPlaying = false;
            }

            // Reset to beginning
            this.pauseTime = 0;
            this.startTime = 0;

            // Update UI
            this.playBtn.disabled = false;
            this.pauseBtn.disabled = true;
            this.playBtn.classList.remove('active');

            // Clear time update interval
            clearInterval(this.timeUpdateInterval);
            this.updateTimeDisplay();
        }

        updateTimeDisplay() {
            if (!this.isWebAudioSupported) return;

            let currentTime = 0;
            if (this.isPlaying) {
                currentTime = (this.audioContext.currentTime - this.startTime) % this.audioBuffer.duration;
            } else {
                currentTime = this.pauseTime;
            }

            const totalTime = this.audioBuffer ? this.audioBuffer.duration : 0;

            // Format time as MM:SS
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            this.timeStatus.textContent = `${formatTime(currentTime)} / ${formatTime(totalTime)}`;
        }
    }

    // Initialize players when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        // Create session timer instance
        const sessionTimer = new SessionTimer();

        // Create player manager instance
        const playerManager = new AudioPlayerManager(sessionTimer);

        // Initialize all pattern players
        const players = {};

        // 5-5 pattern player (first row, first card)
        const player55Container = document.querySelector('.seamless-audio-player[data-audio-id="55"]');
        players.player55 = new SeamlessAudioPlayer(
            player55Container,
            'Coherent_Piano_5_5_fermibot.mp3',
            '55',
            playerManager
        );
        playerManager.registerPlayer('55', players.player55);

        // 6-6 pattern player (first row, second card)
        const player66Container = document.querySelector('.seamless-audio-player[data-audio-id="66"]');
        players.player66 = new SeamlessAudioPlayer(
            player66Container,
            'Coherent_Piano_6_6_fermibot.mp3',
            '66',
            playerManager
        );
        playerManager.registerPlayer('66', players.player66);

        // 7-7 pattern player (second row, first card)
        const player77Container = document.querySelector('.seamless-audio-player[data-audio-id="77"]');
        players.player77 = new SeamlessAudioPlayer(
            player77Container,
            'Coherent_Piano_7_7_fermibot.mp3',
            '77',
            playerManager
        );
        playerManager.registerPlayer('77', players.player77);

        // 8-8 pattern player (second row, second card)
        const player88Container = document.querySelector('.seamless-audio-player[data-audio-id="88"]');
        players.player88 = new SeamlessAudioPlayer(
            player88Container,
            'Coherent_Piano_8_8_fermibot.mp3',
            '88',
            playerManager
        );
        playerManager.registerPlayer('88', players.player88);

        // Store players and timer for global access if needed
        window.audioPlayers = {
            ...players,
            sessionTimer,
            playerManager
        };
    });
</script>

</body>
</html>